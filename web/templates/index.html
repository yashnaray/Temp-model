<!DOCTYPE html>
<html>
<head>
    <title>Property Analysis System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; }
        textarea { width: 100%; height: 100px; }
        .result { background: #f9f9f9; padding: 15px; margin: 10px 0; }
        .download-btn { background: #007bff; color: white; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Property Analysis System</h1>
        
        <div class="section">
            <h2>Ask a Question</h2>
            <textarea id="question" placeholder="Enter your property question..."></textarea>
            <select id="queryType">
                <option value="general">General</option>
                <option value="cost_estimation">Cost Estimation</option>
                <option value="regulatory">Regulatory</option>
            </select>
            <button onclick="askQuestion()">Ask Question</button>
        </div>

        <div class="section">
            <h2>Analyze Property Images</h2>
            <input type="file" id="images" multiple accept="image/*">
            <input type="text" id="address" placeholder="Property address (optional)">
            <select id="analysisType">
                <option value="full">Full Analysis</option>
                <option value="insurance">Insurance Focus</option>
                <option value="real_estate">Real Estate Focus</option>
            </select>
            <button onclick="analyzeImages()">Analyze Images</button>
        </div>

        <div class="section">
            <h2>Generate Final Report</h2>
            <button onclick="generateFinalReport()">Generate Comprehensive Report</button>
        </div>

        <div id="results" class="result" style="display:none;">
            <h3>Results</h3>
            <div id="resultContent"></div>
            <button class="download-btn" onclick="downloadPDF()">Download PDF Report</button>
        </div>
    </div>

    <script>
        let currentMarkdown = '';

        async function askQuestion() {
            const question = document.getElementById('question').value;
            const queryType = document.getElementById('queryType').value;
            
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question, query_type: queryType})
            });
            
            const result = await response.json();
            if (result.success) {
                currentMarkdown = result.markdown;
                document.getElementById('resultContent').innerHTML = result.html;
                document.getElementById('results').style.display = 'block';
            }
        }

        async function analyzeImages() {
            const formData = new FormData();
            const files = document.getElementById('images').files;
            for (let file of files) {
                formData.append('images', file);
            }
            formData.append('address', document.getElementById('address').value);
            formData.append('analysis_type', document.getElementById('analysisType').value);
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                currentMarkdown = result.markdown;
                document.getElementById('resultContent').innerHTML = result.html;
                document.getElementById('results').style.display = 'block';
            }
        }

        async function generateFinalReport() {
            const response = await fetch('/api/final-report', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            if (result.success) {
                currentMarkdown = result.markdown;
                document.getElementById('resultContent').innerHTML = result.html;
                document.getElementById('results').style.display = 'block';
            }
        }

        async function downloadPDF() {
            const response = await fetch('/api/generate-pdf', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({markdown: currentMarkdown})
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'property_report.pdf';
                a.click();
            }
        }
    </script>
</body>
</html>